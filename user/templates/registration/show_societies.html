{% extends "base.html" %} 
{% load static %} 
{% block content %} 

<div class="content-header">
    <div class="row">
        <div class="col-8 text-left">
            <h4 class="page-title">Societies Name</h4>
        </div>
        <div class="col-4 text-right">
            <button onclick="window.location.href='{% url 'add_society' %}'" class="waves-effect waves-light btn bg-gradient-info"><i class="fa fa-plus" aria-hidden="true"></i> Add</button>
        </div>
    </div>
</div>

<section class="content">
  <div class="row">
    <div class="col-12">
      <div class="box">
        <div class="box-body">
          <div class="table-responsive">
            <table id="example1" class="table  table-hover">
              <thead>
                <tr>
                    <th>Sr.No</th>
                    <th width="30%">Society Name</th>
                    <th width="30%">Type</th>
                    <th width="30%">Interval</th>
                    <th width="10%">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for society in societies|dictsortreversed:"id" %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                    <td class="clickable" onclick="redirectToDetails({{ society.id }})">
                      {{ society.name }}
                    </td>
                    <td>
                      {% for soc in society.type.all %}
                      {{ soc }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </td>
                    <td>{{ society.get_interval_display|default:"N/A" }}</td>
                    <td style="display: flex;">
                        <a href="{% url 'edit_society' society.id %}" class="waves-effect waves-light btn mr-2 bg-gradient-primary"><i class="fa fa-edit"></i></a>
                        <button  onclick="deleteSociety({{ society.id }})" class="waves-effect waves-light btn bg-gradient-danger">
                            <i class="fa fa-trash"></i>
                        </button>
                        <form
                            id="delete-form-{{ society.id }}"
                            method="POST"
                            action="{% url 'delete_society' society.id %}"
                            style="display: none" >
                            {% csrf_token %}
                            <input type="hidden" name="_method" value="DELETE" />
                        </form>
                    </td>
                  </tr>
                  {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


<script>
  function redirectToDetails(societyId) {
    window.location.href = `{% url 'society_details' 0 %}`.replace(
      "0",
      societyId
    );
  }

  function fetchSocietyDetails(societyId) {
    fetch(`/api/get_society_details/${societyId}/`)
      .then((response) => response.json())
      .then((data) => {
        const sidebar = document.getElementById("sidebar");
        const societyDetails = document.getElementById("society-details");
        societyDetails.innerHTML = `
                        <p><strong>ID:</strong> ${data.id}</p>
                        <p><strong>Name:</strong> ${data.name}</p>
                        <p><strong>Type:</strong> ${data.type}</p>
                    `;
        sidebar.style.display = "block";
      })
      .catch((error) =>
        console.error("Error fetching society details:", error)
      );
  }

  function selectSociety(societyId, element) {
    console.log("Society name clicked for society:", societyId);
    localStorage.setItem("selectedSocietyId", societyId);
    element.style.color = "blue"; // Change color to blue
    fetchSocietyDetails(societyId);
  }

  function closeSidebar() {
    document.getElementById("sidebar").style.display = "none";
  }

  function deleteSociety(societyId) {
    if (confirm("Are you sure you want to delete this society?")) {
      const form = document.getElementById(`delete-form-${societyId}`);
      if (form) {
        form.submit();
      } else {
        console.error(`Delete form for society ${societyId} not found`);
        alert(
          "Error: Delete form not found. Please refresh the page and try again."
        );
      }
    }
  }


</script>
{% endblock %}
