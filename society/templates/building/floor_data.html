{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="content-header">
    <div class="row">
        <div class="col-8 text-left">
            <h2 class="page-title">Resident List</h2>
        </div>
        {% if request.user.is_superuser %}
        <div class="col-4 text-right">
            <button onclick="window.location.href='{% url 'add_resident' request.resolver_match.kwargs.building_id request.resolver_match.kwargs.id %}'" class="waves-effect waves-light btn bg-gradient-info">
                <i class="fa fa-plus" aria-hidden="true"></i> Add
            </button>
        </div>
        {% else %}
        <div class="col-4 text-right">
            <button onclick="window.location.href='{% url 'add_resident' request.resolver_match.kwargs.building_id request.user.id %}'" class="waves-effect waves-light btn bg-gradient-info">
                <i class="fa fa-plus" aria-hidden="true"></i> Add
            </button>
        </div>
        {% endif %}
    </div>
</div>

<section class="content">
    <div class="row">
        <div class="col-12">
            <div class="box">
                <div class="box-body">
                    <div class="table-responsive">
                        <table id="example1" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Sr.No</th>
                                    <th width="15%">Name</th>
                                    <th width="20%">Email</th>
                                    <th width="20%">Phone Number</th>
                                    <th width="20%">Flat Number</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                {% for resident in members %}
                                <tr id="resident-row-{{ resident.id }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <a href="#" class="resident-name" data-id="{{ resident.id }}" data-toggle="modal" data-target="#familyModal-{{ resident.id }}">{{ resident.user.fullname }}</a>
                                        <div class="modal fade" id="familyModal-{{ resident.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalCenterTitle">Family Details</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <table>
                                                            <thead>
                                                                <tr>
                                                                    <th>Full Name</th>
                                                                    <th>Date of Birth</th>
                                                                    <th>Gender</th>
                                                                    <th>Phone Number</th>
                                                                    <th>Relation</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for member in resident.family_members.all %}
                                                                <tr>
                                                                    <td>{{ member.fullname }}</td>
                                                                    <td>{{ member.date_of_birth }}</td>
                                                                    <td>{{ member.gender }}</td>
                                                                    <td>{{ member.phone_number }}</td>
                                                                    <td>{{ member.family_relation }}</td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    
                                    <td>{{ resident.user.email }}</td>
                                    <td>{{ resident.user.phone_number }}</td>
                                    <td>{{ resident.flat_number }}</td>
                                    <td>
                                        <a href="{% url 'edit_resident' id=request.resolver_match.kwargs.id building_id=building.id member_id=resident.id %}" class="waves-effect waves-light btn mr-2 bg-gradient-primary">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <button class="delete-button waves-effect waves-light btn bg-gradient-danger" data-id="{{ resident.id }}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<script>
    function deleteResident(residentId) {
        if (confirm("Are you sure you want to delete this resident?")) {
            const csrfToken = getCookie('csrftoken');
            fetch(`/delete_resident/${residentId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.status === 204) {
                    alert('Resident deleted successfully.');
                    document.getElementById(`resident-row-${residentId}`).remove();
                } else {
                    response.json().then(data => alert(data.error));
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function() {
            const residentId = this.getAttribute('data-id');
            deleteResident(residentId);
        });
    });

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const tableBody = document.getElementById('tableBody');
        const rows = tableBody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            let match = false;

            for (let j = 0; j < cells.length; j++) {
                const cell = cells[j];
                if (cell.textContent.toLowerCase().indexOf(filter) > -1) {
                    match = true;
                    break;
                }
            }

            if (match) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}
